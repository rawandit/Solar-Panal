<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>حسابات نظام الطاقة الشمسية</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Amiri', Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
      direction: rtl;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .main-title {
      text-align: center;
      color: #333;
      font-size: 2em;
      margin-bottom: 20px;
    }

    .form-section {
      margin-bottom: 30px;
    }

    .form-title {
      font-size: 1.5em;
      color: #444;
      margin-bottom: 15px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-label {
      display: block;
      font-size: 1.1em;
      color: #555;
      margin-bottom: 5px;
    }

    .input-field {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    .calculate-btn, .download-btn {
      display: block;
      width: 100%;
      padding: 12px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1.1em;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .calculate-btn:hover, .download-btn:hover {
      background-color: #218838;
    }

    .results-section {
      margin-top: 20px;
    }

    .results-header {
      display: flex;
      align-items: center;
      background-color: #007bff;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    .results-icon {
      margin-left: 10px;
    }

    .results-title {
      margin: 0;
      font-size: 1.3em;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .result-label {
      font-weight: bold;
      color: #444;
    }

    .result-value {
      color: #007bff;
    }

    .suggestions-box, .warning-box {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
    }

    .suggestions-box {
      background-color: #e9f7ef;
    }

    .suggestions-header {
      font-weight: bold;
      color: #28a745;
    }

    .suggestion-item {
      margin: 5px 0;
    }

    .warning-box {
      background-color: #fff3cd;
    }

    .warning-header {
      font-weight: bold;
      color: #856404;
    }

    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
    }

    .download-section {
      margin-top: 20px;
      text-align: center;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .checkbox-label {
      margin-right: 10px;
      font-size: 1.1em;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="main-title"><i class="fas fa-solar-panel"></i> حسابات نظام الطاقة الشمسية</h1>
    
    <!-- Single Phase Form (By Panels) -->
    <div class="form-section">
      <h2 class="form-title"><i class="fas fa-plug"></i> مرحلة واحدة - الحساب بعدد الألواح</h2>
      <div class="input-group">
        <label class="input-label"><i class="fas fa-solar-panel"></i> عدد الألواح</label>
        <input type="number" class="input-field" id="panelCount" placeholder="أدخل عدد الألواح">
      </div>
      <div class="input-group">
        <label class="input-label"><i class="fas fa-bolt"></i> قدرة اللوح (واط)</label>
        <input type="number" class="input-field" id="panelWatt" placeholder="أدخل قدرة اللوح بالواط">
      </div>
      <div class="input-group">
        <label class="input-label"><i class="fas fa-dollar-sign"></i> سعر اللوح الواحد (دولار)</label>
        <input type="number" class="input-field" id="panelPrice" placeholder="أدخل سعر اللوح الواحد بالدولار">
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="useBattery" checked>
        <label class="checkbox-label" for="useBattery"><i class="fas fa-battery-half"></i> استخدام بطارية</label>
      </div>
      <div class="input-group" id="batteryOptions">
        <label class="input-label"><i class="fas fa-clock"></i> ساعات الدعم</label>
        <input type="number" class="input-field" id="backupHours" placeholder="أدخل عدد الساعات" value="8">
        <label class="input-label"><i class="fas fa-battery-half"></i> جهد نظام البطارية</label>
        <select class="input-field" id="batteryVoltage">
          <option value="12">12V</option>
          <option value="24">24V</option>
          <option value="48" selected>48V</option>
        </select>
      </div>
      <button class="calculate-btn" onclick="calculateByPanels()"><i class="fas fa-calculator"></i> حساب</button>
    </div>

    <!-- Single Phase Form (By Amps) -->
    <div class="form-section">
      <h2 class="form-title"><i class="fas fa-plug"></i> مرحلة واحدة - الحساب بالأمبير</h2>
      <div class="input-group">
        <label class="input-label"><i class="fas fa-tachometer-alt"></i> الأمبير</label>
        <input type="number" class="input-field" id="amps" placeholder="أدخل الأمبير">
      </div>
      <div class="input-group">
        <label class="input-label"><i class="fas fa-bolt"></i> قدرة اللوح (واط)</label>
        <input type="number" class="input-field" id="panelWattAmp" placeholder="أدخل قدرة اللوح بالواط">
      </div>
      <div class="input-group">
        <label class="input-label"><i class="fas fa-dollar-sign"></i> سعر اللوح الواحد (دولار)</label>
        <input type="number" class="input-field" id="panelPriceAmp" placeholder="أدخل سعر اللوح الواحد بالدولار">
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="useBatteryAmp" checked>
        <label class="checkbox-label" for="useBatteryAmp"><i class="fas fa-battery-half"></i> استخدام بطارية</label>
      </div>
      <div class="input-group" id="batteryOptionsAmp">
        <label class="input-label"><i class="fas fa-clock"></i> ساعات الدعم</label>
        <input type="number" class="input-field" id="backupHoursAmp" placeholder="أدخل عدد الساعات" value="8">
        <label class="input-label"><i class="fas fa-battery-half"></i> جهد نظام البطارية</label>
        <select class="input-field" id="batteryVoltageAmp">
          <option value="12">12V</option>
          <option value="24">24V</option>
          <option value="48" selected>48V</option>
        </select>
      </div>
      <button class="calculate-btn" onclick="calculateByAmps()"><i class="fas fa-calculator"></i> حساب</button>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="results"></div>

    <!-- Download PDF Button -->
    <div class="download-section" id="downloadSection" style="display: none;">
      <button class="download-btn" onclick="downloadPDF()"><i class="fas fa-download"></i> تنزيل PDF</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Load Amiri font for jsPDF
    (function() {
      const fontUrl = 'https://raw.githubusercontent.com/alif-type/amiri/master/Amiri-Regular.ttf';
      const fontName = 'Amiri';
      const callAddFont = function() {
        this.addFileToVFS('Amiri-Regular.ttf', fontAmiri);
        this.addFont('Amiri-Regular.ttf', fontName, 'normal');
      };
      const fontAmiri = `AAEAAA...`; // Replace with actual base64 font data or host the font file locally
      jsPDF.API.events.push(['addFonts', callAddFont]);
    })();

    // Show/hide battery options based on checkbox
    function toggleBatteryOptions() {
      const useBattery = document.getElementById("useBattery").checked;
      const useBatteryAmp = document.getElementById("useBatteryAmp").checked;
      document.getElementById("batteryOptions").style.display = useBattery ? "block" : "none";
      document.getElementById("batteryOptionsAmp").style.display = useBatteryAmp ? "block" : "none";
    }

    // Initialize checkbox event listeners
    document.getElementById("useBattery").addEventListener("change", toggleBatteryOptions);
    document.getElementById("useBatteryAmp").addEventListener("change", toggleBatteryOptions);
    toggleBatteryOptions();

    // Show results and toggle PDF download button
    function showResults(html) {
      document.getElementById("results").innerHTML = html;
      document.getElementById("downloadSection").style.display = html.includes("results-section") ? "block" : "none";
    }

    // Suggest inverters based on total kW
    function suggestInverters(totalKW) {
      const inverterOptions = [
        { size: 3.2, price: 250 },
        { size: 4, price: 350 },
        { size: 6, price: 400 },
        { size: 8, price: 1265 },
        { size: 11, price: 845 }
      ];
      let suggestions = [];
      for (let inv of inverterOptions) {
        let count = Math.round(totalKW / inv.size);
        if (count > 0 && count <= 3 && Math.abs(count * inv.size - totalKW) <= 1) {
          suggestions.push({
            text: `${count} عاكس ${inv.size} كيلوواط = ${count * inv.price}$`,
            totalPrice: count * inv.price
          });
        }
      }
      for (let inv of inverterOptions) {
        for (let count = 1; count <= 3; count++) {
          let total = count * inv.size;
          if (Math.abs(total - totalKW) <= 1 && total >= totalKW) {
            suggestions.push({
              text: `${count} عاكس ${inv.size} كيلوواط = ${count * inv.price}$`,
              totalPrice: count * inv.price
            });
          }
        }
      }
      suggestions = [...new Set(suggestions.map(s => s.text))].map(text => ({
        text,
        totalPrice: suggestions.find(s => s.text === text).totalPrice
      }));

      const bestSuggestion = suggestions.length > 0
        ? suggestions.reduce((prev, curr) => (prev.totalPrice < curr.totalPrice ? prev : curr))
        : null;

      return {
        html: suggestions.length > 0
          ? `<div class="suggestions-box">
               <div class="suggestions-header">
                 <i class="fas fa-lightbulb"></i>
                 الاقتراحات لـ ${totalKW.toFixed(2)} كيلوواط:
               </div>
               ${suggestions.map(s => `
                 <div class="suggestion-item">
                   <i class="fas fa-check-circle" style="color: #28a745;"></i>
                   ${s.text}
                 </div>
               `).join('')}
             </div>`
          : `<div class="warning-box">
               <div class="warning-header">
                 <i class="fas fa-exclamation-triangle"></i>
                 لا يوجد عاكس مناسب في قائمة الأحجام لـ ${totalKW.toFixed(2)} كيلوواط.
               </div>
             </div>`,
        totalPrice: bestSuggestion ? bestSuggestion.totalPrice : 0
      };
    }

    // Suggest a single battery based on total kW
    function suggestBatteries(totalKW, backupHours, batteryVoltage) {
      const batteryOptions = [
        { capacity: 5, price: 840 },
        { capacity: 10, price: 1400 },
        { capacity: 15, price: 1680 }
      ];
      const requiredKWh = totalKW * backupHours;
      let bestBattery = batteryOptions[batteryOptions.length - 1]; // Default to 15 kWh
      let actualBackupHours = bestBattery.capacity / totalKW;
      let totalAh = (bestBattery.capacity * 1000) / batteryVoltage;

      return {
        html: `<div class="suggestions-box">
                 <div class="suggestions-header">
                   <i class="fas fa-battery-half"></i>
                   اقتراح البطارية لـ ${requiredKWh.toFixed(2)} كيلوواط ساعة:
                 </div>
                 <div class="suggestion-item">
                   <i class="fas fa-check-circle" style="color: #28a745;"></i>
                   1 بطارية ${bestBattery.capacity} كيلوواط ساعة = ${bestBattery.price}$ (الدعم: ${actualBackupHours.toFixed(2)} ساعة)
                 </div>
                 ${requiredKWh > bestBattery.capacity ? `
                   <div class="warning-box">
                     <div class="warning-header">
                       <i class="fas fa-exclamation-triangle"></i>
                       ملاحظة: بطارية واحدة ${bestBattery.capacity} كيلوواط ساعة تدعم فقط ${actualBackupHours.toFixed(2)} ساعة بدلاً من ${backupHours} ساعة.
                     </div>
                   </div>` : ''}
               </div>`,
        totalPrice: bestBattery.price,
        totalAh: totalAh
      };
    }

    // Calculate by number of panels
    function calculateByPanels() {
      let panelCount = parseFloat(document.getElementById("panelCount").value);
      let panelWatt = parseFloat(document.getElementById("panelWatt").value);
      let panelPrice = parseFloat(document.getElementById("panelPrice").value);
      let useBattery = document.getElementById("useBattery").checked;
      let backupHours = parseFloat(document.getElementById("backupHours").value);
      let batteryVoltage = parseFloat(document.getElementById("batteryVoltage").value);

      if (isNaN(panelCount) || isNaN(panelWatt) || isNaN(panelPrice) || panelCount <= 0 || panelWatt <= 0 || panelPrice <= 0) {
        showResults(`
          <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            الرجاء إدخال أرقام صحيحة وغير سالبة!
          </div>
        `);
        return;
      }
      if (useBattery && (isNaN(backupHours) || isNaN(batteryVoltage) || backupHours <= 0 || batteryVoltage <= 0)) {
        showResults(`
          <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            الرجاء إدخال ساعات الدعم وجهد البطارية بشكل صحيح!
          </div>
        `);
        return;
      }

      let totalWatt = panelCount * panelWatt;
      let totalKW = totalWatt / 1000;
      let amps = (totalWatt / 230) * 0.8;
      let panelTotalPrice = panelCount * panelPrice;
      let structureCost = panelCount * 30;
      let electricalCost = panelCount * 15;
      let inverterSuggestion = suggestInverters(totalKW);
      let batterySuggestion = useBattery ? suggestBatteries(totalKW, backupHours, batteryVoltage) : { html: "", totalPrice: 0, totalAh: 0 };
      let totalCost = panelTotalPrice + structureCost + electricalCost + inverterSuggestion.totalPrice + batterySuggestion.totalPrice;

      showResults(`
        <div class="results-section">
          <div class="results-header">
            <div class="results-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="results-title">نتائج المرحلة الواحدة</h3>
          </div>
          <div class="result-item">
            <div class="result-label"><i class="fas fa-microchip"></i> قدرة العاكس</div>
            <div class="result-value">${totalKW.toFixed(2)} كيلوواط</div>
          </div>
          <div class="result-item">
            <div class="result-label"><i class="fas fa-tachometer-alt"></i> الأمبير</div>
            <div class="result-value">${amps.toFixed(2)} أمبير</div>
          </div>
          <div class="result-item">
            <div class="result-label"><i class="fas fa-solar-panel"></i> عدد الألواح</div>
            <div class="result-value">${panelCount}</div>
          </div>
          <div class="result-item">
            <div class="result-label"><i class="fas fa-dollar-sign"></i> إجمالي سعر الألواح</div>
            <div class="result-value">${panelTotalPrice.toFixed(2)}$</div>
          </div>
          <div class="result-item">
            <div class="result-label"><i class="fas fa-tools"></i> تكلفة الهيكل</div>
            <div class="result-value">${structureCost.toFixed(2)}$</div>
          </div>
          <div class="result-item">
            <div class="result-label"><i class="fas fa-plug"></i> تكلفة التوصيلات الكهربائية</div>
            <div class="result-value">${electricalCost.toFixed(2)}$</div>
          </div>
          ${inverterSuggestion.html}
          ${useBattery ? batterySuggestion.html : `
            <div class="warning-box">
              <div class="warning-header">
                <i class="fas fa-exclamation-triangle"></i>
                لم يتم استخدام بطارية.
              </div>
            </div>`}
          <div class="result-item">
            <div class="result-label"><i class="fas fa-dollar-sign"></i> إجمالي التكلفة</div>
            <div class="result-value">${totalCost.toFixed(2)}$</div>
          </div>
        </div>
      `);

      // Save results for PDF
      window.currentResults = {
        title: "نتائج المرحلة الواحدة - الحساب بعدد الألواح",
        content: `
          قدرة العاكس: ${totalKW.toFixed(2)} كيلوواط
          الأمبير: ${amps.toFixed(2)} أمبير
          عدد الألواح: ${panelCount}
          إجمالي سعر الألواح: ${panelTotalPrice.toFixed(2)}$
          تكلفة الهيكل: ${structureCost.toFixed(2)}$
          تكلفة التوصيلات الكهربائية: ${electricalCost.toFixed(2)}$
          ${inverterSuggestion.html.replace(/<[^>]+>/g, '')}
          ${useBattery ? batterySuggestion.html.replace(/<[^>]+>/g, '') : 'لم يتم استخدام بطارية.'}
          إجمالي التكلفة: ${totalCost.toFixed(2)}$
        `
      };
    }

    // Calculate by amps
    function calculateByAmps() {
      let amps = parseFloat(document.getElementById("amps").value);
      let panelWatt = parseFloat(document.getElementById("panelWattAmp").value);
      let panelPrice = parseFloat(document.getElementById("panelPriceAmp").value);
      let useBattery = document.getElementById("useBatteryAmp").checked;
      let backupHours = parseFloat(document.getElementById("backupHoursAmp").value);
      let batteryVoltage = parseFloat(document.getElementById("batteryVoltageAmp").value);

      if (isNaN(amps) || isNaN(panelWatt) || isNaN(panelPrice) || amps <= 0 || panelWatt <= 0 || panelPrice <= 0) {
        showResults(`
          <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            الرجاء إدخال أرقام صحيحة وغير سالبة!
          </div>
        `);
        return;
      }
      if (useBattery && (isNaN(backupHours) || isNaN(batteryVoltage) || backupHours <= 0 || batteryVoltage <= 0)) {
        showResults(`
          <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            الرجاء إدخال ساعات الدعم وجهد البطارية بشكل صحيح!
          </div>
        `);
        return;
      }

      let totalWatt = (amps / 0.8) * 230;
      let totalKW = totalWatt / 1000;
      let panelCount = Math.ceil(totalWatt / panelWatt);
      let panelTotalPrice = panelCount * panelPrice;
      let structureCost = panelCount * 30;
      let electricalCost = panelCount * 15;
      let inverterSuggestion = suggestInverters(totalKW);
      let batterySuggestion = useBattery ? suggestBatteries(totalKW, backupHours, batteryVoltage) : { html: "", totalPrice: 0, totalAh: 0 };
      let totalCost = panelTotalPrice + structureCost + electricalCost + inverterSuggestion.totalPrice + batterySuggestion.totalPrice;

      showResults(`
        <div class="results-section">
          <div class="results-header">
            <div class="results-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="results-title">نتائج المرحلة الواحدة</h3>
          </div>
          <div class="result-item">
            <div class="result-label"><i class="fas fa-microchip"></i> قدرة العاكس</div>
            <div class="result-value">${totalKW.toFixed(2)} كيلوواط</div>
          </div>
          <div class="result-item">
            <div class="result-label"><i class="fas fa-tachometer-alt"></i> الأمبير</div>
            <div class="result-value">${amps.toFixed(2)} أمبير</div>
          </div>
          <div class="result-item">
            <div class="result-label"><i class="fas fa-solar-panel"></i> عدد الألواح</div>
            <div class="result-value">${panelCount}</div>
          </div>
          <div class="result-item">
            <div class="result-label"><i class="fas fa-dollar-sign"></i> إجمالي سعر الألواح</div>
            <div class="result-value">${panelTotalPrice.toFixed(2)}$</div>
          </div>
          <div class="result-item">
            <div class="result-label"><i class="fas fa-tools"></i> تكلفة الهيكل</div>
            <div class="result-value">${structureCost.toFixed(2)}$</div>
          </div>
          <div class="result-item">
            <div class="result-label"><i class="fas fa-plug"></i> تكلفة التوصيلات الكهربائية</div>
            <div class="result-value">${electricalCost.toFixed(2)}$</div>
          </div>
          ${inverterSuggestion.html}
          ${useBattery ? batterySuggestion.html : `
            <div class="warning-box">
              <div class="warning-header">
                <i class="fas fa-exclamation-triangle"></i>
                لم يتم استخدام بطارية.
              </div>
            </div>`}
          <div class="result-item">
            <div class="result-label"><i class="fas fa-dollar-sign"></i> إجمالي التكلفة</div>
            <div class="result-value">${totalCost.toFixed(2)}$</div>
          </div>
        </div>
      `);

      // Save results for PDF
      window.currentResults = {
        title: "نتائج المرحلة الواحدة - الحساب بالأمبير",
        content: `
          قدرة العاكس: ${totalKW.toFixed(2)} كيلوواط
          الأمبير: ${amps.toFixed(2)} أمبير
          عدد الألواح: ${panelCount}
          إجمالي سعر الألواح: ${panelTotalPrice.toFixed(2)}$
          تكلفة الهيكل: ${structureCost.toFixed(2)}$
          تكلفة التوصيلات الكهربائية: ${electricalCost.toFixed(2)}$
          ${inverterSuggestion.html.replace(/<[^>]+>/g, '')}
          ${useBattery ? batterySuggestion.html.replace(/<[^>]+>/g, '') : 'لم يتم استخدام بطارية.'}
          إجمالي التكلفة: ${totalCost.toFixed(2)}$
        `
      };
    }

    // Download PDF
    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFont("Amiri", "normal");
      doc.setFontSize(16);
      doc.text(window.currentResults.title, 190, 10, { align: "right" });
      doc.setFontSize(12);
      doc.text(window.currentResults.content, 190, 20, { align: "right" });
      doc.save("Solar_System_Calculation.pdf");
    }
  </script>
</body>
</html>
