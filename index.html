<script>
    function calculateCost() {
        try {
            const kwhInput = document.getElementById('kwhInput').value.trim().replace(',', '.');
            const kwh = parseFloat(kwhInput);
            const category = document.getElementById('categorySelect').value;

            if (isNaN(kwh) || kwhInput === '') {
                showError('تکایە ژمارەیەکی دروست بۆ kWh بنووسە!');
                return;
            }

            let cost = 0;

            if (category === 'residential') {
                if (kwh > 0) cost += Math.min(kwh, 400) * 72;
                if (kwh > 400) cost += Math.min(kwh - 400, 400) * 108;
                if (kwh > 800) cost += Math.min(kwh - 800, 400) * 175;
                if (kwh > 1200) cost += Math.min(kwh - 1200, 400) * 265;
                if (kwh > 1600) cost += (kwh - 1600) * 350;
            } else if (category === 'commercial') {
                cost = kwh * 185;
            } else if (category === 'small_industry') {
                cost = kwh * 160;
            } else if (category === 'large_commercial') {
                cost = kwh * 125;
            } else if (category === 'agriculture') {
                cost = kwh * 60;
            }

            document.getElementById('totalCost').textContent = `کۆی گشتی پسووڵە: ${formatNumber(cost)} دینار`;
            document.getElementById('error').textContent = '';
        } catch (e) {
            showError(`هەڵەیەک ڕوویدا: ${e.message}`);
        }
    }

    function resetForm() {
        document.getElementById('kwhInput').value = '';
        document.getElementById('categorySelect').value = 'residential';
        document.getElementById('totalCost').textContent = 'کۆی گشتی پسووڵە: ٠ دینار';
        document.getElementById('error').textContent = '';
    }

    function formatNumber(number) {
        return Math.round(number).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function showError(message) {
        document.getElementById('error').textContent = message;
        document.getElementById('totalCost').textContent = 'کۆی گشتی پسووڵە: ٠ دینار';
    }

    // بۆ سەردان و بەکارهێنەری ئۆنلاین
    (() => {
        // زیادکردنی ژمارەی گشتیی سەردانەکان
        let totalVisits = localStorage.getItem('totalVisits');
        if (!totalVisits) {
            totalVisits = 1;
        } else {
            totalVisits = parseInt(totalVisits) + 1;
        }
        localStorage.setItem('totalVisits', totalVisits);
        document.getElementById('visitCounter').textContent =
            `ژمارەی گشتی سەردانەکان: ${formatNumber(totalVisits)}`;

        // زیادکردنی کۆنترۆڵی بەکارهێنەری ئۆنلاین
        const sessionId = `user_${Math.random().toString(36).substr(2, 9)}`;
        sessionStorage.setItem('session_id', sessionId);
        const timestamp = Date.now();
        localStorage.setItem(sessionId, timestamp);

        function cleanOldSessions() {
            const now = Date.now();
            const expiryTime = 15000; // 15 چرکە
            for (let key in localStorage) {
                if (key.startsWith('user_')) {
                    const lastActive = parseInt(localStorage.getItem(key));
                    if (now - lastActive > expiryTime) {
                        localStorage.removeItem(key);
                    }
                }
            }
        }

        function updateOnlineCount() {
            cleanOldSessions();
            localStorage.setItem(sessionId, Date.now()); // نوێکردنەوەی تایم‌ستامپ

            let onlineCount = 0;
            for (let key in localStorage) {
                if (key.startsWith('user_')) {
                    onlineCount++;
                }
            }

            document.getElementById('onlineUsers').textContent =
                `بەکارهێنەری ئۆنلاین: ${onlineCount}`;
        }

        updateOnlineCount();
        setInterval(updateOnlineCount, 5000);
    })();
</script>
